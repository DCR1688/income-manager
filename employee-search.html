<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥ä¿¡æ¯æ£€ç´¢ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        :root {
            --primary-color: #007AFF;
            --secondary-color: #5856D6;
            --background-color: #F2F2F7;
            --surface-color: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: #C6C6C8;
            --success-color: #34C759;
            --error-color: #FF3B30;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--surface-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 60px 20px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23007AFF" fill-opacity="0.1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,202.7C672,203,768,181,864,181.3C960,181,1056,203,1152,213.3C1248,224,1344,224,1392,224L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
            background-position: center;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .search-section {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-box {
            display: flex;
            background-color: var(--background-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .search-box input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            font-size: 17px;
            background-color: transparent;
            outline: none;
        }
        
        .search-box button {
            background-color: transparent;
            color: var(--primary-color);
            border: none;
            padding: 0 20px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .search-box button:active {
            transform: scale(0.95);
        }
        
        .upload-section {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            transition: background-color 0.2s;
            background-color: var(--surface-color);
        }
        
        .upload-header:active {
            background-color: var(--background-color);
        }
        
        .upload-header h2 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-content {
            display: none;
            padding: 0 20px 20px;
            background-color: var(--surface-color);
        }
        
        .upload-content.show {
            display: block;
        }
        
        .data-section {
            display: none;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .table-container {
            background-color: var(--surface-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--background-color);
            font-weight: 600;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr {
            transition: background-color 0.2s;
        }
        
        tr:active {
            background-color: var(--background-color);
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .no-data .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .no-data p {
            font-size: 17px;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .delete-btn {
            background-color: transparent;
            color: var(--error-color);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }
        
        .delete-btn:active {
            background-color: rgba(255, 59, 48, 0.1);
            transform: scale(0.95);
        }
        
        .message {
            padding: 14px 16px;
            margin: 16px 0;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            font-size: 15px;
        }
        
        .success {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--error-color);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
            padding: 12px 16px;
            background-color: var(--background-color);
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .file-upload {
            padding: 30px 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            text-align: center;
            background-color: var(--background-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:active {
            background-color: #E5E5EA;
            border-color: var(--primary-color);
        }
        
        .file-upload.highlight {
            background-color: rgba(0, 122, 255, 0.05);
            border-color: var(--primary-color);
        }
        
        .file-upload p {
            margin-bottom: 12px;
            font-size: 17px;
            color: var(--text-primary);
        }
        
        .file-upload .file-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 16px;
        }
        
        .file-format {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 12px;
        }
        
        .toggle-icon {
            font-size: 18px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .github-config {
            margin-bottom: 20px;
            padding: 16px;
            background-color: var(--background-color);
            border-radius: 12px;
        }
        
        .github-config h3 {
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            background-color: var(--surface-color);
        }
        
        .config-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .save-config-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .save-config-btn:active {
            background-color: #0056CC;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .error-details {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 59, 48, 0.1);
            border-radius: 8px;
            font-size: 14px;
            color: var(--error-color);
        }
        
        .retry-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .batch-controls {
            margin-top: 15px;
            padding: 15px;
            background-color: rgba(0, 122, 255, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .batch-info {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .batch-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .batch-btn {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .batch-btn:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .container {
                border-radius: 0;
            }
            
            header {
                padding: 40px 16px 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .main-content {
                padding: 16px;
            }
            
            th, td {
                padding: 12px 16px;
            }
        }
        
        @media (max-width: 400px) {
            th, td {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .search-box input {
                padding: 12px 14px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‘˜å·¥ä¿¡æ¯æ£€ç´¢ç³»ç»Ÿ</h1>
            <p class="description">ä¸Šä¼ CSVæ–‡ä»¶æ‰¹é‡æ·»åŠ å‘˜å·¥ä¿¡æ¯ï¼Œæ”¯æŒå¿«é€Ÿæ£€ç´¢æŸ¥æ‰¾</p>
        </header>
        
        <div class="main-content">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢å‘˜å·¥ä¿¡æ¯...">
                    <button id="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div id="message-area"></div>
            </div>
            
            <div class="upload-section">
                <div class="upload-header" id="upload-header">
                    <h2>
                        <i class="fas fa-cloud-upload-alt"></i>
                        ä¸Šä¼ å‘˜å·¥ä¿¡æ¯
                    </h2>
                    <div class="toggle-icon">â–¼</div>
                </div>
                
                <div class="upload-content" id="upload-content">
                    <div class="github-config">
                        <h3><i class="fab fa-github"></i> GitHub é…ç½®</h3>
                        <input type="password" id="github-token" class="config-input" placeholder="GitHub Personal Access Token">
                        <input type="text" id="github-repo" class="config-input" placeholder="ä»“åº“åç§° (ä¾‹å¦‚: username/income-manager)" value="DCR1688/income-manager">
                        <button id="save-config-btn" class="save-config-btn">ä¿å­˜é…ç½®</button>
                        <div class="sync-status" id="sync-status">
                            <i class="fas fa-sync-alt"></i>
                            <span>æœªåŒæ­¥åˆ°GitHub</span>
                        </div>
                        
                        <!-- åˆ†æ‰¹ä¸Šä¼ æ§åˆ¶ -->
                        <div class="batch-controls" id="batch-controls" style="display: none;">
                            <div class="batch-info" id="batch-info">
                                æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®åˆ†æ‰¹ä¸Šä¼ ä»¥é¿å…GitHubæ˜¾ç¤ºé—®é¢˜
                            </div>
                            <div class="batch-buttons">
                                <button class="batch-btn" id="batch-upload-btn">åˆ†æ‰¹ä¸Šä¼ åˆ°GitHub</button>
                                <button class="batch-btn" id="clear-data-btn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                            </div>
                        </div>
                        
                        <div id="error-details" class="error-details" style="display: none;"></div>
                    </div>
                    
                    <div class="file-upload" id="file-upload-area">
                        <div class="file-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
                        <input type="file" id="file-input" accept=".csv" style="display: none;">
                        <div class="file-format">
                            æ–‡ä»¶æ ¼å¼ï¼šå·¥ä½œå•ä½,å§“å,ç”µè¯
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="data-section" id="data-section">
                <div class="table-container">
                    <table id="employee-table">
                        <thead>
                            <tr>
                                <th>å·¥ä½œå•ä½</th>
                                <th>å§“å</th>
                                <th>ç”µè¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="employee-data">
                            <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                    <div id="no-data" class="no-data">
                        <div class="icon">ğŸ“Š</div>
                        <p>æœªæ‰¾åˆ°åŒ¹é…çš„å‘˜å·¥ä¿¡æ¯</p>
                    </div>
                </div>
                
                <div class="stats">
                    <div>æ€»è®°å½•æ•°: <span id="total-count">0</span></div>
                    <div>å½“å‰æ˜¾ç¤º: <span id="display-count">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å­˜å‚¨å‘˜å·¥æ•°æ®çš„æ•°ç»„
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        
        // GitHubé…ç½®
        let githubConfig = JSON.parse(localStorage.getItem('githubConfig')) || {
            token: '',
            repo: 'DCR1688/income-manager'
        };
        
        // å­˜å‚¨åŠ è½½çŠ¶æ€
        let dataLoaded = false;
        
        // DOMå…ƒç´ 
        const fileInput = document.getElementById('file-input');
        const fileUploadArea = document.getElementById('file-upload-area');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const employeeData = document.getElementById('employee-data');
        const noData = document.getElementById('no-data');
        const messageArea = document.getElementById('message-area');
        const totalCount = document.getElementById('total-count');
        const displayCount = document.getElementById('display-count');
        const dataSection = document.getElementById('data-section');
        const uploadHeader = document.getElementById('upload-header');
        const uploadContent = document.getElementById('upload-content');
        const toggleIcon = document.querySelector('.toggle-icon');
        const githubTokenInput = document.getElementById('github-token');
        const githubRepoInput = document.getElementById('github-repo');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const syncStatus = document.getElementById('sync-status');
        const errorDetails = document.getElementById('error-details');
        const batchControls = document.getElementById('batch-controls');
        const batchInfo = document.getElementById('batch-info');
        const batchUploadBtn = document.getElementById('batch-upload-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');

        // åŠ å¯†å¯†é’¥
        const ENCRYPTION_KEY = "employee_secret_key_2024";
        
        // ç®€å•çš„åŠ å¯†å‡½æ•°
        function encryptText(text) {
            if (!text) return '';
            
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                const keyChar = ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                const encryptedChar = String.fromCharCode((charCode + keyChar) % 65536);
                result += encryptedChar;
            }
            return result;
        }
        
        // è§£å¯†å‡½æ•°
        function decryptText(encryptedText) {
            if (!encryptedText) return '';
            
            let result = '';
            for (let i = 0; i < encryptedText.length; i++) {
                const charCode = encryptedText.charCodeAt(i);
                const keyChar = ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                const decryptedChar = String.fromCharCode((charCode - keyChar + 65536) % 65536);
                result += decryptedChar;
            }
            return result;
        }
        
        // åŠ å¯†å‘˜å·¥æ•°æ®
        function encryptEmployeeData(employeeArray) {
            return employeeArray.map(employee => ({
                id: employee.id,
                workplace: encryptText(employee.workplace),
                name: encryptText(employee.name),
                phone: encryptText(employee.phone)
            }));
        }
        
        // è§£å¯†å‘˜å·¥æ•°æ®
        function decryptEmployeeData(encryptedArray) {
            return encryptedArray.map(employee => ({
                id: employee.id,
                workplace: decryptText(employee.workplace),
                name: decryptText(employee.name),
                phone: decryptText(employee.phone)
            }));
        }
        
        // åˆå§‹åŒ–
        async function init() {
            updateStats();
            loadGitHubConfig();
            checkDataSize();
            
            const savedEmployees = localStorage.getItem('employees');
            if (savedEmployees) {
                try {
                    employees = JSON.parse(savedEmployees);
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®:', employees.length, 'æ¡è®°å½•');
                    dataLoaded = true;
                } catch (e) {
                    console.error('æœ¬åœ°å­˜å‚¨æ•°æ®è§£æå¤±è´¥:', e);
                    employees = [];
                    localStorage.removeItem('employees');
                }
            }
            
            if (githubConfig.token && githubConfig.repo) {
                console.log('æ£€æµ‹åˆ°GitHubé…ç½®ï¼Œå°è¯•ä»GitHubåŠ è½½æ•°æ®...');
                await loadFromGitHub();
            } else {
                console.log('æœªæ£€æµ‹åˆ°GitHubé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                dataLoaded = true;
            }
        }
        
        // åŠ è½½GitHubé…ç½®
        function loadGitHubConfig() {
            githubTokenInput.value = githubConfig.token || '';
            githubRepoInput.value = githubConfig.repo || 'DCR1688/income-manager';
        }
        
        // æ£€æŸ¥æ•°æ®å¤§å°
        function checkDataSize() {
            const dataSize = JSON.stringify(employees).length;
            const maxSize = 800000; // 800KB å®‰å…¨é˜ˆå€¼
            
            if (dataSize > maxSize) {
                batchControls.style.display = 'block';
                batchInfo.innerHTML = `
                    å½“å‰æ•°æ®å¤§å°: ${(dataSize / 1024).toFixed(2)} KB<br>
                    <small>GitHubå»ºè®®æ–‡ä»¶å¤§å°æ§åˆ¶åœ¨800KBä»¥å†…ä»¥ç¡®ä¿æ­£å¸¸æ˜¾ç¤º</small>
                `;
            } else {
                batchControls.style.display = 'none';
            }
        }
        
        // ä¿å­˜GitHubé…ç½®
        saveConfigBtn.addEventListener('click', async function() {
            githubConfig.token = githubTokenInput.value.trim();
            githubConfig.repo = githubRepoInput.value.trim();
            
            if (!validateGitHubConfig()) {
                return;
            }
            
            errorDetails.style.display = 'none';
            
            try {
                updateSyncStatus('æ­£åœ¨æµ‹è¯•GitHubè¿æ¥...', 'syncing');
                
                const testResponse = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!testResponse.ok) {
                    if (testResponse.status === 404) {
                        throw new Error('ä»“åº“ä¸å­˜åœ¨æˆ–æ‚¨æ— æƒè®¿é—®');
                    } else if (testResponse.status === 401) {
                        throw new Error('Tokenæ— æ•ˆæˆ–æƒé™ä¸è¶³');
                    } else {
                        throw new Error(`è¿æ¥æµ‹è¯•å¤±è´¥: ${testResponse.status}`);
                    }
                }
                
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                showMessage('GitHubé…ç½®å·²ä¿å­˜å¹¶éªŒè¯æˆåŠŸ', 'success');
                
                await loadFromGitHub();
                
            } catch (error) {
                console.error('GitHubé…ç½®æµ‹è¯•å¤±è´¥:', error);
                handleGitHubError(error, 'load');
            }
        });
        
        // éªŒè¯GitHubé…ç½®
        function validateGitHubConfig() {
            if (!githubConfig.token) {
                showMessage('è¯·è¾“å…¥GitHub Token', 'error');
                return false;
            }
            
            if (!githubConfig.repo || githubConfig.repo === 'username/income-manager') {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„ä»“åº“åç§°', 'error');
                return false;
            }
            
            if (!githubConfig.repo.includes('/')) {
                showMessage('ä»“åº“åç§°æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º: ç”¨æˆ·å/ä»“åº“å', 'error');
                return false;
            }
            
            return true;
        }
        
        // ä»GitHubåŠ è½½æ•°æ®
        async function loadFromGitHub() {
            try {
                updateSyncStatus('æ­£åœ¨ä»GitHubåŒæ­¥æ•°æ®...', 'syncing');
                
                if (!validateGitHubConfig()) {
                    return;
                }
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/employees.json`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    console.log('GitHubä¸Šæœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                    updateSyncStatus('GitHubä¸Šæœªæ‰¾åˆ°æ•°æ®æ–‡ä»¶ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®', 'not-synced');
                    dataLoaded = true;
                    return;
                }
                
                if (response.status === 403) {
                    throw new Error('APIé™åˆ¶æˆ–æƒé™ä¸è¶³ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                if (response.status === 401) {
                    throw new Error('Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥Tokenæƒé™');
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub APIé”™è¯¯: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = base64ToUtf8(data.content);
                
                let encryptedEmployees;
                try {
                    encryptedEmployees = JSON.parse(content);
                } catch (parseError) {
                    console.error('GitHubæ•°æ®JSONè§£æå¤±è´¥:', parseError);
                    throw new Error('GitHubä¸Šçš„æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹');
                }
                
                employees = decryptEmployeeData(encryptedEmployees);
                localStorage.setItem('employees', JSON.stringify(employees));
                
                updateSyncStatus('æ•°æ®å·²ä»GitHubåŒæ­¥', 'synced');
                showMessage('æ•°æ®å·²ä»GitHubåŒæ­¥', 'success');
                dataLoaded = true;
                
                console.log('ä»GitHubæˆåŠŸåŠ è½½æ•°æ®:', employees.length, 'æ¡è®°å½•');
                
            } catch (error) {
                console.error('ä»GitHubåŠ è½½æ•°æ®å¤±è´¥:', error);
                dataLoaded = true;
                handleGitHubError(error, 'load');
            }
        }
        
        // Base64è½¬UTF-8
        function base64ToUtf8(base64) {
            try {
                if (typeof TextDecoder !== 'undefined') {
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    return new TextDecoder('utf-8').decode(bytes);
                }
                return decodeURIComponent(escape(atob(base64)));
            } catch (error) {
                console.error('Base64è§£ç å¤±è´¥:', error);
                return atob(base64);
            }
        }
        
        // UTF-8è½¬Base64
        function utf8ToBase64(str) {
            try {
                if (typeof TextEncoder !== 'undefined') {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(str);
                    const binaryString = String.fromCharCode(...data);
                    return btoa(binaryString);
                }
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, 
                    function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }
                ));
            } catch (error) {
                console.error('Base64ç¼–ç å¤±è´¥:', error);
                return btoa(unescape(encodeURIComponent(str)));
            }
        }
        
        // åˆ†æ‰¹ä¸Šä¼ æ•°æ®åˆ°GitHub
        batchUploadBtn.addEventListener('click', async function() {
            await uploadInBatches();
        });
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        clearDataBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å‘˜å·¥æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                employees = [];
                localStorage.removeItem('employees');
                updateStats();
                checkDataSize();
                showMessage('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
                dataSection.style.display = 'none';
            }
        });
        
        // åˆ†æ‰¹ä¸Šä¼ å‡½æ•°
        async function uploadInBatches() {
            if (!validateGitHubConfig()) {
                return;
            }
            
            const BATCH_SIZE = 500;
            const totalBatches = Math.ceil(employees.length / BATCH_SIZE);
            
            updateSyncStatus(`å‡†å¤‡ä¸Šä¼  ${totalBatches} æ‰¹æ•°æ®...`, 'syncing');
            
            try {
                for (let i = 0; i < totalBatches; i++) {
                    const start = i * BATCH_SIZE;
                    const end = start + BATCH_SIZE;
                    const batch = employees.slice(start, end);
                    
                    updateSyncStatus(`æ­£åœ¨ä¸Šä¼ ç¬¬ ${i + 1}/${totalBatches} æ‰¹æ•°æ®...`, 'syncing');
                    
                    await uploadBatchToGitHub(batch, i);
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                updateSyncStatus('æ‰€æœ‰æ•°æ®å·²åˆ†æ‰¹ä¸Šä¼ å®Œæˆ', 'synced');
                showMessage(`æˆåŠŸä¸Šä¼  ${employees.length} æ¡è®°å½•ï¼ˆ${totalBatches} æ‰¹ï¼‰`, 'success');
                
            } catch (error) {
                console.error('åˆ†æ‰¹ä¸Šä¼ å¤±è´¥:', error);
                handleGitHubError(error, 'batch-upload');
            }
        }
        
        // ä¸Šä¼ å•ä¸ªæ‰¹æ¬¡åˆ°GitHub
        async function uploadBatchToGitHub(batchData, batchIndex) {
            const batchFileName = `employees_batch_${batchIndex + 1}.json`;
            
            let sha = null;
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${batchFileName}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    sha = data.sha;
                }
            } catch (error) {
                // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º
            }
            
            const encryptedBatch = encryptEmployeeData(batchData);
            const jsonData = JSON.stringify(encryptedBatch);
            const content = utf8ToBase64(jsonData);
            
            const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/${batchFileName}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `ä¸Šä¼ å‘˜å·¥æ•°æ®æ‰¹æ¬¡ ${batchIndex + 1}`,
                    content: content,
                    sha: sha
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`æ‰¹æ¬¡ ${batchIndex + 1} ä¸Šä¼ å¤±è´¥: ${response.status} - ${errorData.message || response.statusText}`);
            }
            
            console.log(`æ‰¹æ¬¡ ${batchIndex + 1} ä¸Šä¼ æˆåŠŸ`);
        }
        
        // ä¿å­˜åˆ°GitHub
        async function saveToGitHub() {
            if (!githubConfig.token || !githubConfig.repo) {
                return;
            }
            
            const dataSize = JSON.stringify(employees).length;
            if (dataSize > 800000) {
                batchControls.style.display = 'block';
                showMessage('æ•°æ®é‡è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨åˆ†æ‰¹ä¸Šä¼ åŠŸèƒ½', 'error');
                return;
            }
            
            try {
                updateSyncStatus('æ­£åœ¨åŒæ­¥åˆ°GitHub...', 'syncing');
                
                let sha = null;
                try {
                    const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/employees.json`, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                    }
                } catch (error) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º
                }
                
                const encryptedEmployees = encryptEmployeeData(employees);
                const jsonData = JSON.stringify(encryptedEmployees);
                console.log('è¦ä¿å­˜çš„æ•°æ®å¤§å°:', jsonData.length, 'å­—ç¬¦');
                
                const content = utf8ToBase64(jsonData);
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}/contents/employees.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `æ›´æ–°å‘˜å·¥æ•°æ® - ${new Date().toLocaleString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`GitHub APIé”™è¯¯: ${response.status} - ${errorData.message || response.statusText}`);
                }
                
                updateSyncStatus('æ•°æ®å·²åŒæ­¥åˆ°GitHub', 'synced');
                showMessage('æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°GitHub', 'success');
                
            } catch (error) {
                console.error('ä¿å­˜åˆ°GitHubå¤±è´¥:', error);
                handleGitHubError(error, 'save');
            }
        }
        
        // å¤„ç†GitHubé”™è¯¯
        function handleGitHubError(error, operation) {
            let errorMessage = 'GitHubæ“ä½œå¤±è´¥: ';
            let detailedMessage = '';
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage += 'ç½‘ç»œè¿æ¥å¤±è´¥';
                detailedMessage = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–GitHubå¯èƒ½æš‚æ—¶ä¸å¯ç”¨ã€‚å¦‚æœæ‚¨åœ¨ä½¿ç”¨ä»£ç†ï¼Œè¯·ç¡®ä¿é…ç½®æ­£ç¡®ã€‚';
            } else if (error.message.includes('401')) {
                errorMessage += 'Tokenæ— æ•ˆæˆ–æƒé™ä¸è¶³';
                detailedMessage = 'è¯·æ£€æŸ¥ï¼š\n1. Tokenæ˜¯å¦æ­£ç¡®\n2. Tokenæ˜¯å¦å…·æœ‰repoæƒé™\n3. Tokenæ˜¯å¦å·²è¿‡æœŸ';
            } else if (error.message.includes('403')) {
                errorMessage += 'APIé™åˆ¶æˆ–æƒé™æ‹’ç»';
                detailedMessage = 'å¯èƒ½åŸå› ï¼š\n1. APIé€Ÿç‡é™åˆ¶\n2. ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®\n3. Tokenæƒé™ä¸è¶³';
            } else if (error.message.includes('404')) {
                errorMessage += 'ä»“åº“æˆ–æ–‡ä»¶æœªæ‰¾åˆ°';
                detailedMessage = 'è¯·æ£€æŸ¥ï¼š\n1. ä»“åº“åç§°æ˜¯å¦æ­£ç¡®\n2. ä»“åº“æ˜¯å¦å­˜åœ¨\n3. æ‚¨æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ä»“åº“';
            } else if (error.message.includes('JSONè§£æå¤±è´¥') || error.message.includes('Unexpected end of JSON input') || error.message.includes('æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯')) {
                errorMessage += 'æ•°æ®æ ¼å¼é”™è¯¯';
                detailedMessage = 'GitHubä¸Šçš„æ•°æ®æ–‡ä»¶å¯èƒ½å·²æŸåã€‚å»ºè®®é‡æ–°ä¸Šä¼ æ•°æ®æ–‡ä»¶ã€‚';
            } else if (error.message.includes('æ•°æ®æ–‡ä»¶è¿‡å¤§')) {
                errorMessage += 'æ•°æ®æ–‡ä»¶è¿‡å¤§';
                detailedMessage = 'GitHubæ— æ³•åœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºè¿‡å¤§çš„æ–‡ä»¶ã€‚æ•°æ®ä»ç„¶ä¿å­˜åœ¨ä»“åº“ä¸­ï¼Œå¯ä»¥é€šè¿‡APIæ­£å¸¸è®¿é—®ã€‚å»ºè®®ï¼š\n1. åˆ†æ‰¹ä¸Šä¼ æ•°æ®\n2. åˆ é™¤ä¸å¿…è¦çš„è®°å½•\n3. ä½¿ç”¨æ•°æ®åˆ†ç‰‡åŠŸèƒ½';
            } else {
                errorMessage += error.message;
                detailedMessage = error.message;
            }
            
            updateSyncStatus('åŒæ­¥å¤±è´¥', 'error');
            showMessage(errorMessage, 'error');
            
            errorDetails.innerHTML = `
                <strong>è¯¦ç»†é”™è¯¯ä¿¡æ¯:</strong><br>
                ${detailedMessage.replace(/\n/g, '<br>')}
                <button class="retry-btn" onclick="retryGitHubOperation('${operation}')">é‡è¯•</button>
            `;
            errorDetails.style.display = 'block';
        }
        
        // é‡è¯•GitHubæ“ä½œ
        function retryGitHubOperation(operation) {
            errorDetails.style.display = 'none';
            if (operation === 'load') {
                loadFromGitHub();
            } else if (operation === 'save') {
                saveToGitHub();
            } else if (operation === 'batch-upload') {
                uploadInBatches();
            }
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€
        function updateSyncStatus(message, status) {
            const icon = syncStatus.querySelector('i');
            const text = syncStatus.querySelector('span');
            
            text.textContent = message;
            
            syncStatus.className = 'sync-status';
            
            if (status === 'syncing') {
                icon.className = 'fas fa-sync-alt fa-spin';
                syncStatus.classList.add('syncing');
            } else if (status === 'synced') {
                icon.className = 'fas fa-check-circle';
                syncStatus.classList.add('synced');
            } else if (status === 'error') {
                icon.className = 'fas fa-exclamation-circle';
                syncStatus.classList.add('error');
            } else {
                icon.className = 'fas fa-sync-alt';
            }
        }
        
        // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('highlight');
        });
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('highlight');
        });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('highlight');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload();
            }
        });
        fileInput.addEventListener('change', handleFileUpload);
        
        // æœç´¢äº‹ä»¶
        searchBtn.addEventListener('click', searchEmployees);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                searchEmployees();
            } else {
                searchEmployees();
            }
        });
        
        searchInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                dataSection.style.display = 'none';
                updateStats(employees.length, 0);
            } else {
                searchEmployees();
            }
        });
        
        // ä¸Šä¼ åŒºåŸŸæŠ˜å /å±•å¼€
        uploadHeader.addEventListener('click', function() {
            uploadContent.classList.toggle('show');
            toggleIcon.classList.toggle('rotated');
        });
        
        // åˆ é™¤å‘˜å·¥å‡½æ•°
        function deleteEmployee(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å‘˜å·¥ä¿¡æ¯å—ï¼Ÿ')) {
                employees = employees.filter(employee => employee.id !== id);
                saveEmployees();
                if (searchInput.value.trim()) {
                    searchEmployees();
                } else {
                    dataSection.style.display = 'none';
                }
                updateStats();
                showMessage('å‘˜å·¥ä¿¡æ¯åˆ é™¤æˆåŠŸ', 'success');
            }
        }
        
        // æ˜¾ç¤ºå‘˜å·¥æ•°æ®
        function displayEmployees(data) {
            employeeData.innerHTML = '';
            
            if (data.length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            noData.style.display = 'none';
            
            data.forEach(employee => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${employee.workplace}</td>
                    <td>${employee.name}</td>
                    <td>${employee.phone}</td>
                    <td class="action-buttons">
                        <button class="delete-btn" onclick="deleteEmployee(${employee.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                employeeData.appendChild(row);
            });
        }
        
        // æœç´¢å‘˜å·¥
        function searchEmployees() {
            if (!dataLoaded && employees.length === 0) {
                showMessage('æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å...', 'error');
                return;
            }
            
            const keyword = searchInput.value.trim();
            
            if (!keyword) {
                dataSection.style.display = 'none';
                updateStats(employees.length, 0);
                return;
            }
            
            dataSection.style.display = 'block';
            
            const filteredEmployees = employees.filter(employee => {
                if (employee.workplace && employee.workplace.includes(keyword)) {
                    return true;
                }
                
                if (employee.name && employee.name.includes(keyword)) {
                    return true;
                }
                
                if (employee.phone && employee.phone.includes(keyword)) {
                    return true;
                }
                
                return false;
            });
            
            displayEmployees(filteredEmployees);
            updateStats(employees.length, filteredEmployees.length);
            
            if (filteredEmployees.length === 0) {
                showMessage('æœªæ‰¾åˆ°åŒ¹é…çš„å‘˜å·¥ä¿¡æ¯', 'error');
                console.log('æœç´¢å…³é”®è¯:', keyword);
                console.log('å¯ç”¨æ•°æ®:', employees);
            } else {
                console.log('æ‰¾åˆ°', filteredEmployees.length, 'æ¡åŒ¹é…è®°å½•');
            }
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload() {
            const file = fileInput.files[0];
            
            if (!file) {
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('è¯·ä¸Šä¼ CSVæ ¼å¼çš„æ–‡ä»¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                let addedCount = 0;
                let errorCount = 0;
                let errorDetails = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const lineNumber = i + 1;
                    
                    if (!line) continue;
                    
                    const parts = line.split(',');
                    
                    if (parts.length < 3) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: å­—æ®µæ•°é‡ä¸è¶³ (éœ€è¦3ä¸ªå­—æ®µï¼Œå®é™…${parts.length}ä¸ª)`);
                        continue;
                    }
                    
                    const workplace = parts[0].trim();
                    const name = parts[1].trim();
                    const phone = parts[2].trim();
                    
                    if (!workplace) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: å·¥ä½œå•ä½ä¸èƒ½ä¸ºç©º`);
                        continue;
                    }
                    
                    if (!name) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: å§“åä¸èƒ½ä¸ºç©º`);
                        continue;
                    }
                    
                    if (!phone) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: ç”µè¯ä¸èƒ½ä¸ºç©º`);
                        continue;
                    }
                    
                    if (!/^[\d\-\+\(\)\s]{10,}$/.test(phone.replace(/\D/g, ''))) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: ç”µè¯å·ç æ ¼å¼ä¸æ­£ç¡® (éœ€è¦è‡³å°‘10ä½æ•°å­—)`);
                        continue;
                    }
                    
                    const isDuplicate = employees.some(emp => 
                        emp.workplace === workplace && 
                        emp.name === name && 
                        emp.phone === phone
                    );
                    
                    if (isDuplicate) {
                        errorCount++;
                        errorDetails.push(`ç¬¬${lineNumber}è¡Œ: å‘˜å·¥ä¿¡æ¯å·²å­˜åœ¨ (${workplace}, ${name}, ${phone})`);
                        continue;
                    }
                    
                    const employee = {
                        workplace,
                        name,
                        phone,
                        id: Date.now() + i
                    };
                    
                    employees.push(employee);
                    addedCount++;
                }
                
                saveEmployees();
                updateStats();
                
                let message = `æˆåŠŸæ·»åŠ  ${addedCount} æ¡å‘˜å·¥ä¿¡æ¯`;
                if (errorCount > 0) {
                    message += `ï¼Œ${errorCount} æ¡è®°å½•æ ¼å¼é”™è¯¯æˆ–é‡å¤`;
                    console.log('è¯¦ç»†é”™è¯¯ä¿¡æ¯:', errorDetails);
                    if (errorDetails.length > 0) {
                        const previewErrors = errorDetails.slice(0, 3).join('; ');
                        showMessage(`${message} (ç¤ºä¾‹: ${previewErrors}...)`, addedCount > 0 ? 'success' : 'error');
                    } else {
                        showMessage(message, addedCount > 0 ? 'success' : 'error');
                    }
                } else {
                    showMessage(message, 'success');
                }
                
                fileInput.value = '';
                dataLoaded = true;
                
                if (searchInput.value.trim()) {
                    searchEmployees();
                }
            };
            
            reader.onerror = function() {
                showMessage('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // ä¿å­˜å‘˜å·¥æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨å’ŒGitHub
        function saveEmployees() {
            localStorage.setItem('employees', JSON.stringify(employees));
            checkDataSize();
            saveToGitHub();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(total = employees.length, display = 0) {
            totalCount.textContent = total;
            displayCount.textContent = display;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>
