<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="收入表管理">
    <title>收入表管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #8E8E93;
            --ios-light-gray: #F2F2F7;
            --ios-card-bg: #FFFFFF;
            --ios-border: #C6C6C8;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-orange: #FF9500;
            --ios-purple: #AF52DE;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', sans-serif;
            background: var(--ios-light-gray);
            padding: 0;
            color: #000;
            font-size: 17px;
            line-height: 1.47059;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            margin: 0;
            padding: 16px;
            font-weight: 400;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .app-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 20px;
        }
        
        .desktop-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 992px) {
            .desktop-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .header {
            background: #fff;
            color: #000;
            padding: 24px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            grid-column: 1 / -1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 0.5px solid var(--ios-border);
        }
        
        .header h4 {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 22px;
            letter-spacing: -0.5px;
        }
        
        .header p {
            opacity: 0.6;
            margin-bottom: 0;
            font-size: 16px;
            font-weight: 400;
        }
        
        .card {
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
            background: var(--ios-card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 0.5px solid var(--ios-border);
        }
        
        .card-header {
            background: var(--ios-card-bg);
            border-bottom: 0.5px solid var(--ios-border);
            padding: 16px;
            font-weight: 600;
            color: #000;
            font-size: 17px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .card-header i {
            margin-right: 12px;
            color: var(--ios-blue);
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .card-body {
            padding: 16px;
        }
        
        .collapsible-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .collapsible-section.collapsed {
            display: none;
        }
        
        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 16px;
            border: 0.5px solid var(--ios-border);
            transition: all 0.2s;
            background: #fff;
            font-size: 17px;
            height: 48px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--ios-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #000;
            font-size: 16px;
            display: block;
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 14px 20px;
            transition: all 0.2s;
            border: none;
            font-size: 17px;
            height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--ios-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--ios-border);
            color: var(--ios-blue);
        }
        
        .btn-outline:hover {
            background: rgba(0, 122, 255, 0.1);
        }
        
        .summary-card {
            background: var(--ios-blue);
            color: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }
        
        .summary-card h2 {
            font-weight: 700;
            font-size: 28px;
            margin: 8px 0;
            letter-spacing: -0.5px;
        }
        
        .monthly-summary {
            background: var(--ios-green);
            color: white;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.2);
        }
        
        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            background: #fff;
            border: 0.5px solid var(--ios-border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead th {
            background: #F2F2F7;
            font-weight: 600;
            color: #000;
            padding: 12px 16px;
            border: none;
            font-size: 15px;
            text-align: left;
        }
        
        tbody td {
            padding: 12px 16px;
            vertical-align: middle;
            border-bottom: 0.5px solid var(--ios-border);
            font-size: 15px;
        }
        
        tbody tr:last-child td {
            border-bottom: none;
        }
        
        .delete-btn {
            color: var(--ios-red);
            cursor: pointer;
            display: inline-flex;
            width: 32px;
            height: 32px;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            background: rgba(255, 59, 48, 0.1);
        }
        
        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--ios-gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .input-with-percent {
            position: relative;
        }
        
        .input-with-percent .form-control {
            padding-right: 50px;
        }
        
        .percent-symbol {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--ios-gray);
            font-weight: 500;
        }
        
        .calculated-field {
            background: #F2F2F7;
            font-weight: 600;
            color: #000;
        }
        
        .cost-section, .rebate-section {
            background: #F2F2F7;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        
        .smart-cost-info {
            background: #E8F5E8;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 14px;
            color: #2E7D32;
            border-left: 3px solid var(--ios-green);
        }
        
        .formula-hint {
            font-size: 13px;
            color: var(--ios-gray);
            margin-top: 4px;
        }
        
        .cost-section-title, .rebate-section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .salesperson-management, .product-management {
            margin-top: 12px;
            padding: 16px;
            background: #F2F2F7;
            border-radius: 12px;
        }
        
        .salesperson-list, .product-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .salesperson-tag, .product-tag {
            background: #fff;
            padding: 6px 12px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 0.5px solid var(--ios-border);
            font-size: 14px;
        }
        
        .details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .details-modal.active {
            display: flex;
        }
        
        .details-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--ios-border);
        }
        
        .details-title {
            font-weight: 600;
            font-size: 18px;
            color: #000;
        }
        
        .details-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--ios-gray);
            cursor: pointer;
            padding: 5px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--ios-light-gray);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-size: 14px;
            color: var(--ios-gray);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 14px;
            font-weight: 600;
            color: #000;
            text-align: right;
        }
        
        .toggle-details {
            color: var(--ios-blue);
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0, 122, 255, 0.1);
        }
        
        .cloud-storage-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .cloud-storage-section .card-body {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .cloud-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sync-indicator.syncing {
            background: #e6f3ff;
            color: #007AFF;
        }
        
        .sync-indicator.synced {
            background: #e6f4ea;
            color: #137333;
        }
        
        .sync-indicator.error {
            background: #fce8e6;
            color: #c5221f;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h4><i class="fas fa-chart-line"></i> 收入表管理系统</h4>
                    <p>智能成本计算 - 移动端优化版</p>
                </div>
            </div>
        </div>

        <div class="desktop-layout">
            <div class="left-column">
                <div class="card cloud-storage-section">
                    <div class="card-header" onclick="toggleSection('cloudStorageSection')">
                        <span><i class="fas fa-cloud"></i> 云端存储</span>
                        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="collapsible-section collapsed" id="cloudStorageSection">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-12 mb-3">
                                    <label class="form-label text-white">加密密码</label>
                                    <input type="password" class="form-control" id="master-password-input" placeholder="设置云端加密密码">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <button type="button" class="btn cloud-btn w-100" onclick="setMasterPassword()"><i class="fas fa-key"></i> 设置密码</button>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <button type="button" class="btn cloud-btn w-100" onclick="saveDataToCloud()"><i class="fas fa-cloud-upload-alt"></i> 保存到云端</button>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <button type="button" class="btn cloud-btn w-100" onclick="loadDataFromCloud()"><i class="fas fa-cloud-download-alt"></i> 从云端加载</button>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <button type="button" class="btn cloud-btn w-100" onclick="testCloudConnection()"><i class="fas fa-wifi"></i> 测试连接</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleSection('dataFormSection')">
                        <span><i class="fas fa-plus-circle"></i> 新增数据记录</span>
                        <span class="toggle-icon"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="collapsible-section" id="dataFormSection">
                        <div class="card-body">
                            <form id="dataForm">
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">业务员</label>
                                        <select class="form-select" id="salesperson" required>
                                            <option value="">请选择业务员</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">客户</label>
                                        <input type="text" class="form-control" id="client" required placeholder="请输入客户名称">
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">办理产品</label>
                                        <select class="form-select" id="product" required>
                                            <option value="">请选择产品</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">放款日期</label>
                                        <input type="date" class="form-control" id="loanDate" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">放款金额 (元)</label>
                                        <input type="number" class="form-control" id="loanAmount" required placeholder="0.00" min="0" step="0.01">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">服务费率</label>
                                        <div class="input-with-percent">
                                            <input type="number" class="form-control" id="serviceRate" required placeholder="0" min="0" max="100" step="0.01">
                                            <span class="percent-symbol">%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> 添加记录</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <h5><i class="fas fa-calculator"></i> 总提成汇总</h5>
                        <h2 id="totalCommission">0.00</h2>
                        <p>元</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>业务员</th>
                                        <th>客户</th>
                                        <th>提成</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <tr>
                                        <td colspan="4" class="empty-state">
                                            <i class="fas fa-inbox"></i>
                                            <p>暂无数据，请添加记录</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline" id="clearDataBtn"><i class="fas fa-trash-alt"></i> 清空数据</button>
                    <button type="button" class="btn btn-outline" id="exportDataBtn"><i class="fas fa-download"></i> 导出CSV</button>
                </div>
            </div>
        </div>
    </div>

    <div class="sync-indicator" id="syncIndicator" style="display: none;">
        <i class="fas fa-sync"></i>
        <span>同步中...</span>
    </div>

    <script>
        const GITHUB_OWNER='DCR1688';const GITHUB_REPO='income-manager';const GITHUB_PATH='income-data.enc';let masterPassword='';let cloudConfig={};let autoSaveTimeout=null;let dataRecords=[];let salespersonList=['蔡建荣','吴嘉莹','陈建凤','邓映红'];let productList=['信用贷','抵押贷','企业经营贷','消费贷'];
        document.addEventListener('DOMContentLoaded',function(){try{const configStr=sessionStorage.getItem('cloudConfig');if(configStr){cloudConfig=JSON.parse(configStr);GITHUB_OWNER=cloudConfig.username;GITHUB_REPO=cloudConfig.repo||'income-manager';masterPassword=cloudConfig.password;setTimeout(()=>{autoLoadFromCloud(cloudConfig.token);},1000);}}catch(e){console.error('加载云端配置失败:',e);}
        loadDataFromStorage();setTodayDate();initSalespersonOptions();initProductOptions();updateTable();updateSummary();setupEventListeners();});
        function toggleSection(sectionId){const section=document.getElementById(sectionId);const icon=section.previousElementSibling.querySelector('.toggle-icon i');section.classList.toggle('collapsed');icon.className=section.classList.contains('collapsed')?'fas fa-chevron-down':'fas fa-chevron-up';}
        function initSalespersonOptions(){const select=document.getElementById('salesperson');select.innerHTML='<option value="">请选择业务员</option>';salespersonList.forEach(salesperson=>{const option=document.createElement('option');option.value=salesperson;option.textContent=salesperson;select.appendChild(option);});}
        function initProductOptions(){const select=document.getElementById('product');select.innerHTML='<option value="">请选择产品</option>';productList.forEach(product=>{const option=document.createElement('option');option.value=product;option.textContent=product;select.appendChild(option);});}
        function loadDataFromStorage(){try{const savedData=localStorage.getItem('incomeData');const savedSalespersons=localStorage.getItem('salespersonList');const savedProducts=localStorage.getItem('productList');if(savedData)dataRecords=JSON.parse(savedData);if(savedSalespersons)salespersonList=JSON.parse(savedSalespersons);if(savedProducts)productList=JSON.parse(savedProducts);}catch(error){console.error('从localStorage加载数据失败:',error);}}
        function saveDataToStorage(){try{localStorage.setItem('incomeData',JSON.stringify(dataRecords));localStorage.setItem('salespersonList',JSON.stringify(salespersonList));localStorage.setItem('productList',JSON.stringify(productList));triggerAutoSave();}catch(error){console.error('保存到localStorage失败:',error);}}
        function setTodayDate(){const today=new Date();const formattedDate=today.toISOString().split('T')[0];document.getElementById('loanDate').value=formattedDate;}
        function updateMonthlySummary(){const selectedMonth=document.getElementById('monthSelector').value;const[year,month]=selectedMonth.split('-').map(Number);const monthlyCommission=dataRecords.filter(record=>{const recordDate=new Date(record.loanDate);return recordDate.getFullYear()===year&&recordDate.getMonth()+1===month;}).reduce((sum,record)=>sum+record.commission,0);document.getElementById('monthlyCommission').textContent=monthlyCommission.toFixed(2);}
        function updateTable(){const tableBody=document.getElementById('dataTable');if(dataRecords.length===0){tableBody.innerHTML='<tr><td colspan="4" class="empty-state"><i class="fas fa-inbox"></i><p>暂无数据，请添加记录</p></td></tr>';return;}
        tableBody.innerHTML='';dataRecords.forEach((record)=>{const row=document.createElement('tr');row.innerHTML=`<td>${record.salesperson}</td><td>${record.client}</td><td>${record.commission.toFixed(2)}</td><td><span class="toggle-details" onclick="showDetails('${record.id}')"><span>查看详情</span><i class="fas fa-eye"></i></span><span class="delete-btn" onclick="deleteRecord('${record.id}')"><i class="fas fa-trash-alt"></i></span></td>`;tableBody.appendChild(row);});}
        function updateSummary(){const totalCommission=dataRecords.reduce((sum,record)=>sum+record.commission,0);document.getElementById('totalCommission').textContent=totalCommission.toFixed(2);}
        function setupEventListeners(){document.getElementById('dataForm').addEventListener('submit',function(e){e.preventDefault();addRecord();});document.getElementById('clearDataBtn').addEventListener('click',function(){if(confirm('确定要清空所有数据吗？此操作不可恢复！')){dataRecords=[];updateTable();updateSummary();saveDataToStorage();}});document.getElementById('exportDataBtn').addEventListener('click',exportToCSV);}
        function addRecord(){const salesperson=document.getElementById('salesperson').value;const client=document.getElementById('client').value;const product=document.getElementById('product').value;const loanDate=document.getElementById('loanDate').value;const loanAmount=parseFloat(document.getElementById('loanAmount').value);const serviceRate=parseFloat(document.getElementById('serviceRate').value);if(!salesperson||!client||!product||!loanDate||isNaN(loanAmount)||isNaN(serviceRate)){alert('请填写所有必填字段');return;}
        const record={id:Date.now().toString(),salesperson,client,product,loanDate,loanAmount,serviceRate,commission:loanAmount*serviceRate/100*0.3};dataRecords.push(record);updateTable();updateSummary();saveDataToStorage();document.getElementById('dataForm').reset();document.getElementById('loanDate').value=new Date().toISOString().split('T')[0];triggerAutoSave();}
        function deleteRecord(id){if(confirm('确定要删除这条记录吗？')){dataRecords=dataRecords.filter(record=>record.id!==id);updateTable();updateSummary();saveDataToStorage();}}
        function exportToCSV(){if(dataRecords.length===0){alert('没有数据可导出');return;}
        let csvContent="业务员,客户,产品,放款日期,放款金额,服务费率,提成\n";dataRecords.forEach(record=>{csvContent+=`"${record.salesperson}","${record.client}","${record.product}","${record.loanDate}",${record.loanAmount},${record.serviceRate},${record.commission.toFixed(2)}\n`;});const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download=`收入数据_${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(link);link.click();document.body.removeChild(link);}
        async function autoLoadFromCloud(token){if(!token||!masterPassword)return;try{showSyncStatus('syncing','正在从云端加载数据...');const encryptedData=await loadDataFromGitHub(token);if(!encryptedData){showSyncStatus('synced','已加载本地数据（云端无数据）');return;}
        const decryptedString=decryptData(encryptedData,masterPassword);const loadedData=JSON.parse(decryptedString);dataRecords=loadedData.records||[];salespersonList=loadedData.salespersons||salespersonList;productList=loadedData.products||productList;initSalespersonOptions();initProductOptions();updateTable();updateSummary();saveDataToStorage();showSyncStatus('synced','云端数据加载成功！');}catch(error){console.error('从云端加载数据失败:',error);showSyncStatus('error','云端加载失败: '+error.message);}}
        function triggerAutoSave(){if(!cloudConfig.token)return;clearTimeout(autoSaveTimeout);autoSaveTimeout=setTimeout(()=>{saveDataToCloud(cloudConfig.token);},3000);}
        function showSyncStatus(status,message){const indicator=document.getElementById('syncIndicator');indicator.style.display='flex';indicator.className='sync-indicator '+status;indicator.innerHTML=`<i class="fas fa-${getSyncIcon(status)}"></i><span>${message}</span>`;if(status!=='syncing'){setTimeout(()=>{indicator.style.display='none';},5000);}}
        function getSyncIcon(status){switch(status){case'syncing':return'sync-alt';case'synced':return'check-circle';case'error':return'exclamation-circle';default:return'info-circle';}}
        function setMasterPassword(){const passwordInput=document.getElementById('master-password-input');const password=passwordInput.value;if(!password){alert('请先输入加密密码！');return;}
        masterPassword=password;alert('加密密码设置成功！');}
        function encryptData(dataString,password){try{return CryptoJS.AES.encrypt(dataString,password).toString();}catch(error){console.error('加密失败:',error);throw new Error('数据加密失败');}}
        function decryptData(encryptedString,password){try{const bytes=CryptoJS.AES.decrypt(encryptedString,password);const decrypted=bytes.toString(CryptoJS.enc.Utf8);if(!decrypted)throw new Error('解密失败，密码可能错误');return decrypted;}catch(error){console.error('解密失败:',error);throw new Error('数据解密失败');}}
        async function saveDataToGitHub(encryptedData,token){const apiUrl=`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;const contentBase64=btoa(unescape(encodeURIComponent(encryptedData)));let fileSha='';try{const response=await fetch(apiUrl,{headers:{'Authorization':`token ${token}`,'User-Agent':'IncomeManagerApp'}});if(response.ok){const fileInfo=await response.json();fileSha=fileInfo.sha;}}catch(error){console.log('创建新文件');}
        const body={message:'更新收入数据',content:contentBase64,sha:fileSha};const response=await fetch(apiUrl,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json','User-Agent':'IncomeManagerApp'},body:JSON.stringify(body)});if(!response.ok){throw new Error('保存到GitHub失败');}
        return await response.json();}
        async function loadDataFromGitHub(token){const apiUrl=`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;try{const response=await fetch(apiUrl,{headers:{'Authorization':`token ${token}`,'User-Agent':'IncomeManagerApp'}});if(response.status===404){return null;}
        if(!response.ok){throw new Error('从GitHub加载数据失败');}
        const fileInfo=await response.json();return atob(fileInfo.content);}catch(error){console.error('读取数据失败:',error);throw error;}}
        async function saveDataToCloud(){if(!masterPassword){alert('请先设置加密密码！');return;}
        const token=prompt('请输入您的GitHub Personal Access Token：');if(!token){alert('请输入Token才能保存到云端！');return;}
        try{showSyncStatus('syncing','正在保存到云端...');const dataToSave={records:dataRecords,salespersons:salespersonList,products:productList,backupDate:new Date().toISOString()};const dataString=JSON.stringify(dataToSave);const encryptedData=encryptData(dataString,masterPassword);await saveDataToGitHub(encryptedData,token);showSyncStatus('synced','数据已保存到云端！');}catch(error){console.error('保存失败:',error);showSyncStatus('error','保存失败: '+error.message);}}
        async function loadDataFromCloud(){if(!masterPassword){alert('请先设置加密密码！');return;}
        const token=prompt('请输入您的GitHub Personal Access Token：');if(!token){alert('请输入Token才能从云端加载数据！');return;}
        try{showSyncStatus('syncing','正在从云端加载数据...');const encryptedData=await loadDataFromGitHub(token);if(!encryptedData){showSyncStatus('synced','没有找到云端数据！');return;}
        const decryptedString=decryptData(encryptedData,masterPassword);const loadedData=JSON.parse(decryptedString);dataRecords=loadedData.records||[];salespersonList=loadedData.salespersons||salespersonList;productList=loadedData.products||productList;initSalespersonOptions();initProductOptions();updateTable();updateSummary();saveDataToStorage();showSyncStatus('synced','云端数据加载成功！');}catch(error){console.error('加载失败:',error);showSyncStatus('error','加载失败: '+error.message);}}
        function testCloudConnection(){alert('测试云端连接功能\n\n请确保：\n1. 已创建GitHub私有仓库\n2. 已生成Personal Access Token\n3. 已设置加密密码');}
        window.showDetails=function(id){alert('查看详情功能: '+id);};window.hideDetails=function(){};window.deleteRecord=deleteRecord;window.toggleSection=toggleSection;window.setMasterPassword=setMasterPassword;window.saveDataToCloud=saveDataToCloud;window.loadDataFromCloud=loadDataFromCloud;window.testCloudConnection=testCloudConnection;
    </script>
</body>
</html>