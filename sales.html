<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´·æ¬¾æ”¶å…¥è®¡ç®—å™¨ - ä¼˜åŒ–å“åº”å¼ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
<!-- ========== æ–°å¢çš„äº‘ç«¯æ“ä½œæŒ‰é’® ========== -->
<div style="border: 2px solid blue; padding: 10px; margin: 10px; background: #f0f8ff;">
    <h3>ğŸŒ©ï¸ äº‘ç«¯å­˜å‚¨åŠŸèƒ½</h3>
    <p>é¦–å…ˆè®¾ç½®å¯†ç ï¼š<input type="password" id="master-password-input" placeholder="è¾“å…¥åŠ å¯†å¯†ç "> 
       <button onclick="setMasterPassword()">è®¾ç½®å¯†ç </button>
    </p>
    <p>ç„¶åä½¿ç”¨ä¸‹é¢æŒ‰é’®ï¼š</p>
    <button onclick="saveDataToCloud()" style="background: #4CAF50; color: white; padding: 10px;">ğŸ’¾ ä¿å­˜åˆ°äº‘ç«¯</button>
    <button onclick="loadDataFromCloud()" style="background: #2196F3; color: white; padding: 10px;">â˜ï¸ ä»äº‘ç«¯åŠ è½½</button>
    <p style="color: red; font-size: 12px;">æ³¨æ„ï¼šç‚¹å‡»æŒ‰é’®åä¼šå¼¹çª—è¦æ±‚è¾“å…¥GitHub Tokenï¼Œè¯·è¾“å…¥ä½ ä¹‹å‰ç”Ÿæˆçš„é‚£ä¸²å­—ç¬¦</p>
</div>
<!-- ========== æ–°å¢ç»“æŸ ========== -->
            background: #f5f5f7;
            color: #333;
            padding: 15px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .header {
            background: #ffffff;
            color: #000;
            padding: 20px;
            text-align: center;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.6;
            font-size: 14px;
        }
        
        .logo {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .logo-circle {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            background: #007AFF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .section-card {
            background: #ffffff;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            color: #000;
            margin-bottom: 18px;
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .section-title i {
            color: #007AFF;
        }
        
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .input-group {
            flex: 1;
            min-width: 200px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #000;
            font-size: 15px;
            padding-left: 5px;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: #ffffff;
        }
        
        .input-group select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23007AFF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 45px;
        }
        
        .input-group input:focus, .input-group select:focus {
            border-color: #007AFF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        
        .commission-info {
            background: #e6f2ff;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            font-size: 15px;
            color: #007AFF;
            border: 1px solid #b3d7ff;
        }
        
        .btn {
            padding: 14px 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #FF3B30;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-secondary {
            background: #34C759;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2a9e48;
        }
        
        .table-section {
            flex: 2;
            min-width: 300px;
        }
        
        .table-container {
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }
        
        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
            font-size: 14px;
        }
        
        th {
            background: #f9f9f9;
            font-weight: 600;
            color: #000;
            position: sticky;
            top: 0;
        }
        
        .commission-high {
            color: #34C759;
            font-weight: 600;
        }
        
        .commission-low {
            color: #FF3B30;
            font-weight: 600;
        }
        
        .action-cell {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #007AFF;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: #f0f0f0;
        }
        
        .btn-delete {
            color: #FF3B30;
        }
        
        .summary-section {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 10px;
        }
        
        .summary-card {
            flex: 1;
            min-width: 180px;
            background: #ffffff;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .summary-card h3 {
            color: #000;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 22px;
            font-weight: 700;
            color: #007AFF;
        }
        
        .monthly-summary {
            background: #34C759;
            color: white;
        }
        
        .monthly-summary h3 {
            color: white;
        }
        
        .monthly-summary .summary-value {
            color: white;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #8e8e93;
            font-size: 14px;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        /* è¯¦æƒ…å¼¹çª—æ ·å¼ */
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-icon {
            width: 24px;
            text-align: center;
            color: #007AFF;
        }
        
        .detail-label {
            font-weight: 500;
            min-width: 80px;
            font-size: 14px;
        }
        
        .detail-value {
            flex: 1;
            color: #333;
            font-size: 14px;
        }
        
        /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨è®¾å¤‡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .input-group {
                min-width: 100%;
            }
            
            .action-buttons .btn {
                min-width: 100%;
            }
            
            .summary-card {
                min-width: calc(50% - 10px);
            }
            
            table {
                min-width: 100%;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .section-card {
                padding: 15px;
            }
            
            .summary-card {
                min-width: 100%;
            }
            
            .input-group input, .input-group select {
                padding: 12px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 15px;
            }
            
            th, td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .action-cell {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        /* è¶…å°å±å¹•è®¾å¤‡ */
        @media (max-width: 360px) {
            .container {
                gap: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .logo-circle {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .input-row {
                gap: 12px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .commission-info {
                font-size: 14px;
                padding: 12px;
            }
            
            .input-group label {
                font-size: 14px;
            }
            
            .summary-card h3 {
                font-size: 14px;
            }
            
            .summary-value {
                font-size: 18px;
            }
            
            th, td {
                padding: 6px 4px;
                font-size: 11px;
            }
        }
        
        /* å¤§å±å¹•è®¾å¤‡ä¼˜åŒ– */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }
            
            .input-section {
                flex: 0.8;
            }
            
            .table-section {
                flex: 2.2;
            }
        }
        
        /* å¼¹çª—æ ·å¼ */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .popup-content {
            background: white;
            border-radius: 14px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e5ea;
        }
        
        .popup-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #8e8e93;
        }
        
        /* è¡¨æ ¼ç´§å‡‘æ¨¡å¼ */
        .compact-table th, 
        .compact-table td {
            padding: 10px 8px;
        }
        
        /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„è¡¨æ ¼æ»šåŠ¨ */
        .table-scroll {
            overflow-x: auto;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-circle">
                    <i class="fas fa-calculator"></i>
                </div>
            </div>
            <h1>è´·æ¬¾æ”¶å…¥è®¡ç®—å™¨</h1>
            <p>è®¡ç®—è´·æ¬¾ææˆï¼Œæ•°æ®è‡ªåŠ¨ä¿å­˜ - ä¼˜åŒ–å“åº”å¼ç‰ˆ</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="commission-info">
                    <i class="fas fa-info-circle"></i> ææˆè®¡ç®—å…¬å¼: (æ”¾æ¬¾é‡‘é¢ Ã— æœåŠ¡è´¹ç‡ - æ¸ é“æˆæœ¬ - å¹³å°æˆæœ¬ + è¿”ç‚¹) Ã— 30%
                </div>
                
                <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="clientName"><i class="fas fa-user"></i> å®¢æˆ·åç§°</label>
                            <input type="text" id="clientName" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°">
                        </div>
                        
                        <div class="input-group">
                            <label for="loanDate"><i class="fas fa-calendar-alt"></i> æ”¾æ¬¾æ—¥æœŸ</label>
                            <input type="date" id="loanDate">
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label for="productType"><i class="fas fa-box"></i> äº§å“ç±»å‹</label>
                            <select id="productType">
                                <option value="" disabled selected>-- è¯·é€‰æ‹©äº§å“ç±»å‹ --</option>
                                <option value="æŠµæŠ¼">æŠµæŠ¼è´·</option>
                                <option value="ä¿¡ç”¨è´·">ä¿¡ç”¨è´·</option>
                                <option value="ä¼ä¸šè´·">ä¼ä¸šè´·</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="loanAmount"><i class="fas fa-money-bill-wave"></i> æ”¾æ¬¾é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="loanAmount" placeholder="è¯·è¾“å…¥æ”¾æ¬¾é‡‘é¢" step="0.01">
                        </div>
                    </div>
                </div>
                
                <!-- è´¹ç‡ä¿¡æ¯å¡ç‰‡ -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-percent"></i> è´¹ç‡ä¿¡æ¯
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="serviceRate"><i class="fas fa-hand-holding-usd"></i> æœåŠ¡è´¹ç‡ (%)</label>
                            <input type="number" id="serviceRate" placeholder="è¯·è¾“å…¥æœåŠ¡è´¹ç‡" step="0.01">
                        </div>
                        
                        <div class="input-group">
                            <label for="rebateRate"><i class="fas fa-gift"></i> è¿”ç‚¹è´¹ç‡ (%)</label>
                            <input type="number" id="rebateRate" placeholder="è¯·è¾“å…¥è¿”ç‚¹è´¹ç‡" step="0.01" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- æˆæœ¬ä¿¡æ¯å¡ç‰‡ -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-money-bill-alt"></i> æˆæœ¬ä¿¡æ¯
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="channelCost"><i class="fas fa-tag"></i> æ¸ é“æˆæœ¬ (å…ƒ)</label>
                            <input type="number" id="channelCost" placeholder="è¯·è¾“å…¥æ¸ é“æˆæœ¬" step="0.01">
                        </div>
                        
                        <div class="input-group">
                            <label for="platformCost"><i class="fas fa-server"></i> å¹³å°æˆæœ¬ (å…ƒ)</label>
                            <input type="text" id="platformCost" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label for="rebateAmount"><i class="fas fa-gift"></i> è¿”ç‚¹é‡‘é¢ (å…ƒ)</label>
                            <input type="text" id="rebateAmount" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
                        </div>
                        
                        <div class="input-group">
                            <label for="commission"><i class="fas fa-coins"></i> ææˆ (å…ƒ)</label>
                            <input type="text" id="commission" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
                        </div>
                    </div>
                </div>
                
                <button id="addRow" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> æ·»åŠ æ–°è¡Œ
                </button>
                
                <div class="summary-section">
                    <div class="summary-card">
                        <h3><i class="fas fa-chart-pie"></i> æ€»ææˆæ±‡æ€»</h3>
                        <div class="summary-value" id="totalCommission">0</div>
                    </div>
                    
                    <div class="summary-card monthly-summary">
                        <h3><i class="fas fa-calendar-check"></i> æœˆåº¦ææˆæ±‡æ€»</h3>
                        <div class="summary-value" id="monthlyCommission">0</div>
                    </div>
                </div>
            </div>
            
            <div class="table-section">
                <div class="table-container">
                    <div class="table-scroll">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>å®¢æˆ·åç§°</th>
                                    <th>æ”¾æ¬¾é‡‘é¢</th>
                                    <th>ææˆ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="clearData" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> æ¸…é™¤æ•°æ®
                    </button>
                    <button id="exportData" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> å¯¼å‡ºCSV
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Â© 2023 è´·æ¬¾æ”¶å…¥è®¡ç®—å™¨ - ä¼˜åŒ–å“åº”å¼ç‰ˆ | æ”¯æŒè¿”ç‚¹ä¸å¹³å°æˆæœ¬è®¡ç®—</p>
        </div>
    </div>



    <script>
// ========== äº‘ç«¯å­˜å‚¨æ ¸å¿ƒå‡½æ•° ==========
// ç¡®ä¿è¿™æ®µä»£ç åœ¨é¡µé¢çš„æ‰€æœ‰å…¶ä»–JSä»£ç ä¹‹å‰ï¼

// è®¾ç½®ä¸»å¯†ç 
function setMasterPassword() {
    console.log('setMasterPasswordå‡½æ•°å¼€å§‹æ‰§è¡Œ');
    const passwordInput = document.getElementById('master-password-input');
    
    if (!passwordInput) {
        alert('é”™è¯¯ï¼šæ‰¾ä¸åˆ°å¯†ç è¾“å…¥æ¡†ï¼');
        return;
    }
    
    const password = passwordInput.value;
    console.log('è¾“å…¥çš„å¯†ç ï¼š', password);
    
    if (!password) {
        alert('è¯·å…ˆè¾“å…¥åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    // ä¿å­˜å¯†ç åˆ°å…¨å±€å˜é‡
    window.masterPassword = password;
    alert('åŠ å¯†å¯†ç å·²è®¾ç½®æˆåŠŸï¼');
    console.log('å¯†ç å·²ä¿å­˜åˆ°window.masterPassword');
}

// ä¿å­˜åˆ°äº‘ç«¯å‡½æ•°
function saveDataToCloud() {
    console.log('saveDataToCloudå‡½æ•°å¼€å§‹æ‰§è¡Œ');
    alert('ä¿å­˜åŠŸèƒ½å·²ç‚¹å‡»ï¼åç»­éœ€è¦é…ç½®GitHubä¿¡æ¯');
}

// ä»äº‘ç«¯åŠ è½½å‡½æ•°  
function loadDataFromCloud() {
    console.log('loadDataFromCloudå‡½æ•°å¼€å§‹æ‰§è¡Œ');
    alert('åŠ è½½åŠŸèƒ½å·²ç‚¹å‡»ï¼åç»­éœ€è¦é…ç½®GitHubä¿¡æ¯');
}
// ========== å‡½æ•°å®šä¹‰ç»“æŸ ==========
// ========== äº‘ç«¯å­˜å‚¨åŠŸèƒ½å‡½æ•° - ç›´æ¥æ”¾åœ¨è¿™é‡Œ ==========

// é…ç½®ä¿¡æ¯ï¼ˆéœ€è¦ä¿®æ”¹æˆä½ çš„ï¼ï¼‰
const GITHUB_OWNER = 'ä½ çš„GitHubç”¨æˆ·å'; // ä¿®æ”¹ä¸ºä½ çš„GitHubç”¨æˆ·å
const GITHUB_REPO = 'ä½ çš„ä»“åº“åå­—';    // ä¿®æ”¹ä¸ºä½ çš„ä»“åº“å
const GITHUB_PATH = 'encrypted-data.json';

// è®¾ç½®ä¸»å¯†ç 
function setMasterPassword() {
    console.log('setMasterPasswordå‡½æ•°è¢«è°ƒç”¨'); // è°ƒè¯•ä¿¡æ¯
    const passwordInput = document.getElementById('master-password-input');
    const password = passwordInput.value;
    
    if (!password) {
        alert('è¯·å…ˆè¾“å…¥åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    window.masterPassword = password;
    alert('åŠ å¯†å¯†ç å·²è®¾ç½®æˆåŠŸï¼');
    console.log('å¯†ç å·²è®¾ç½®ä¸ºï¼š', password);
}

// åŠ å¯†å‡½æ•°
function encryptData(dataString, password) {
    try {
        const encrypted = CryptoJS.AES.encrypt(dataString, password);
        return encrypted.toString();
    } catch (error) {
        console.error('åŠ å¯†å¤±è´¥:', error);
        alert('åŠ å¯†å¤±è´¥ï¼š' + error.message);
        throw error;
    }
}

// è§£å¯†å‡½æ•°
function decryptData(encryptedString, password) {
    try {
        const bytes = CryptoJS.AES.decrypt(encryptedString, password);
        const decrypted = bytes.toString(CryptoJS.enc.Utf8);
        if (!decrypted) {
            throw new Error('è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®');
        }
        return decrypted;
    } catch (error) {
        console.error('è§£å¯†å¤±è´¥:', error);
        alert('è§£å¯†å¤±è´¥ï¼š' + error.message);
        throw error;
    }
}

// ä¿å­˜åˆ°GitHub
async function saveDataToGitHub(encryptedData, token) {
    const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;
    const contentBase64 = btoa(unescape(encodeURIComponent(encryptedData)));

    let fileSha = '';
    try {
        const response = await fetch(apiUrl, {
            headers: { 'Authorization': `token ${token}` }
        });
        if (response.ok) {
            const fileInfo = await response.json();
            fileSha = fileInfo.sha;
        }
    } catch (error) {
        console.log('åˆ›å»ºæ–°æ–‡ä»¶');
    }

    const body = {
        message: 'æ›´æ–°æ”¶å…¥æ•°æ®',
        content: contentBase64,
        sha: fileSha
    };

    const putResponse = await fetch(apiUrl, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });

    if (!putResponse.ok) {
        throw new Error('ä¿å­˜åˆ°GitHubå¤±è´¥');
    }

    return await putResponse.json();
}

// æ•´åˆä¿å­˜å‡½æ•°
async function saveDataToCloud() {
    if (!window.masterPassword) {
        alert('è¯·å…ˆè®¾ç½®åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    const token = prompt('è¯·è¾“å…¥æ‚¨çš„GitHub Tokenï¼š');
    if (!token) return;
    
    try {
        // è¿™é‡Œéœ€è¦ä½ çŸ¥é“ä½ çš„æ•°æ®å˜é‡åï¼Œæ¯”å¦‚å« incomeData
        const dataToSave = window.incomeData || []; // å¦‚æœä¸çŸ¥é“å˜é‡åï¼Œå…ˆç”¨ç©ºæ•°ç»„æµ‹è¯•
        const dataString = JSON.stringify(dataToSave);
        const encryptedData = encryptData(dataString, window.masterPassword);
        
        await saveDataToGitHub(encryptedData, token);
        alert('âœ… æ•°æ®å·²åŠ å¯†ä¿å­˜åˆ°äº‘ç«¯ï¼');
    } catch (error) {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
}

// æ•´åˆåŠ è½½å‡½æ•°
async function loadDataFromCloud() {
    if (!window.masterPassword) {
        alert('è¯·å…ˆè®¾ç½®åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    const token = prompt('è¯·è¾“å…¥æ‚¨çš„GitHub Tokenï¼š');
    if (!token) return;
    
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`, {
            headers: { 'Authorization': `token ${token}` }
        });
        
        if (response.status === 404) {
            alert('æ²¡æœ‰æ‰¾åˆ°äº‘ç«¯æ•°æ®ï¼');
            return;
        }
        
        if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
        
        const fileInfo = await response.json();
        const encryptedData = atob(fileInfo.content);
        const decryptedString = decryptData(encryptedData, window.masterPassword);
        const loadedData = JSON.parse(decryptedString);
        
        // è¿™é‡Œéœ€è¦ä½ çŸ¥é“ä½ çš„æ•°æ®å˜é‡å
        window.incomeData = loadedData; // å¦‚æœä¸çŸ¥é“å˜é‡åï¼Œå…ˆè¿™æ ·å†™
        alert('âœ… äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸï¼');
        
    } catch (error) {
        alert('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message);
    }
}

// ========== äº‘ç«¯å‡½æ•°ç»“æŸ ==========
            // è·å–DOMå…ƒç´ 
            const clientNameInput = document.getElementById('clientName');
            const loanDateInput = document.getElementById('loanDate');
            const productTypeInput = document.getElementById('productType');
            const loanAmountInput = document.getElementById('loanAmount');
            const serviceRateInput = document.getElementById('serviceRate');
            const channelCostInput = document.getElementById('channelCost');
            const rebateRateInput = document.getElementById('rebateRate');
            const rebateAmountInput = document.getElementById('rebateAmount');
            const platformCostInput = document.getElementById('platformCost');
            const commissionInput = document.getElementById('commission');
            const addRowButton = document.getElementById('addRow');
            const clearDataButton = document.getElementById('clearData');
            const exportDataButton = document.getElementById('exportData');
            const totalCommissionElement = document.getElementById('totalCommission');
            const monthlyCommissionElement = document.getElementById('monthlyCommission');
            const tableBody = document.querySelector('#dataTable tbody');
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            loanDateInput.value = `${yyyy}-${mm}-${dd}`;
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            loadData();
            
            // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼Œæ•´æ•°ä¸æ˜¾ç¤ºå°æ•°éƒ¨åˆ†
            function formatNumber(value) {
                const num = parseFloat(value);
                if (isNaN(num)) return "0";
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ•´æ•°
                if (Number.isInteger(num)) {
                    return num.toString();
                }
                
                // ä¿ç•™ä¸¤ä½å°æ•°
                return num.toFixed(2);
            }
            
            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º (YYYY-MM-DD)
            function formatDate(dateString) {
                if (!dateString) return "";
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                
                return `${yyyy}-${mm}-${dd}`;
            }
            
            // è®¡ç®—è¿”ç‚¹é‡‘é¢
            function calculateRebate() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const rebateRate = parseFloat(rebateRateInput.value) || 0;
                
                const rebateAmount = (loanAmount * rebateRate / 100);
                rebateAmountInput.value = formatNumber(rebateAmount);
                
                return rebateAmount;
            }
            
            // è®¡ç®—å¹³å°æˆæœ¬
            function calculatePlatformCost() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const productType = productTypeInput.value;
                
                // å¦‚æœæœªé€‰æ‹©äº§å“ç±»å‹ï¼Œè¿”å›0
                if (!productType) return 0;
                
                let platformCostRate = 0.01; // é»˜è®¤1%
                if (productType === "ä¿¡ç”¨è´·") {
                    platformCostRate = 0.02; // ä¿¡ç”¨è´·2%
                }
                
                const platformCost = (loanAmount * platformCostRate);
                platformCostInput.value = formatNumber(platformCost);
                
                return platformCost;
            }
            
            // è®¡ç®—ææˆ - ä¿®æ”¹ä¸º (æ”¾æ¬¾é‡‘é¢*æœåŠ¡è´¹ç‡-æ¸ é“æˆæœ¬-å¹³å°æˆæœ¬+è¿”ç‚¹)*30%
            function calculateCommission() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const serviceRate = parseFloat(serviceRateInput.value) || 0;
                const channelCost = parseFloat(channelCostInput.value) || 0;
                const platformCost = calculatePlatformCost();
                const rebateAmount = calculateRebate();
                
                const commission = ((loanAmount * serviceRate / 100 - channelCost - platformCost + rebateAmount) * 0.3);
                commissionInput.value = formatNumber(commission);
                
                return commission;
            }
            
            // è‡ªåŠ¨è®¡ç®—
            function setupAutoCalculation() {
                const inputsToWatch = [loanAmountInput, serviceRateInput, channelCostInput, rebateRateInput];
                
                inputsToWatch.forEach(input => {
                    input.addEventListener('input', calculateCommission);
                });
                
                productTypeInput.addEventListener('change', calculateCommission);
            }
            
            // åˆå§‹åŒ–è‡ªåŠ¨è®¡ç®—
            setupAutoCalculation();
            
            // æ›´æ–°æ€»æ±‡æ€»
            function updateSummary() {
                let total = 0;
                let monthlyTotal = 0;
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const rows = tableBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const commission = parseFloat(row.getAttribute('data-commission')) || 0;
                    total += commission;
                    
                    // è®¡ç®—æœˆåº¦æ±‡æ€»
                    const dateStr = row.getAttribute('data-date');
                    if (dateStr) {
                        const date = new Date(dateStr);
                        if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                            monthlyTotal += commission;
                        }
                    }
                });
                
                totalCommissionElement.textContent = formatNumber(total);
                monthlyCommissionElement.textContent = formatNumber(monthlyTotal);
            }
            
            // æ·»åŠ æ–°è¡Œ
            function addRow() {
                const clientName = clientNameInput.value.trim();
                const loanDate = loanDateInput.value;
                const productType = productTypeInput.value;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const serviceRate = parseFloat(serviceRateInput.value) || 0;
                const channelCost = parseFloat(channelCostInput.value) || 0;
                const rebateRate = parseFloat(rebateRateInput.value) || 0;
                const rebateAmount = parseFloat(rebateAmountInput.value) || 0;
                const platformCost = parseFloat(platformCostInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!clientName || !productType || !loanAmount || !serviceRate) {
                    alert('è¯·å¡«å†™å¿…å¡«å­—æ®µï¼šå®¢æˆ·åç§°ã€äº§å“ç±»å‹ã€æ”¾æ¬¾é‡‘é¢å’ŒæœåŠ¡è´¹ç‡');
                    return;
                }
                
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-date', loanDate);
                newRow.setAttribute('data-commission', commission);
                newRow.setAttribute('data-details', JSON.stringify({
                    clientName,
                    productType,
                    loanDate,
                    loanAmount,
                    serviceRate,
                    channelCost,
                    rebateAmount,
                    platformCost,
                    commission
                }));
                
                newRow.innerHTML = `
                    <td>${clientName}</td>
                    <td>${formatNumber(loanAmount)}</td>
                    <td class="${commission >= 1000 ? 'commission-high' : 'commission-low'}">${formatNumber(commission)}</td>
                    <td class="action-cell">
                        <button class="action-btn expand-btn" title="æŸ¥çœ‹è¯¦æƒ…">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="action-btn btn-delete delete-row" title="åˆ é™¤">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                // æ·»åŠ åˆ°è¡¨æ ¼
                tableBody.appendChild(newRow);
                
                // æ·»åŠ åˆ é™¤è¡Œçš„äº‹ä»¶ç›‘å¬å™¨
                newRow.querySelector('.delete-row').addEventListener('click', function() {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) {
                        newRow.remove();
                        saveDataToLocalStorage();
                        updateSummary();
                    }
                });
                
                // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…çš„äº‹ä»¶ç›‘å¬å™¨
                newRow.querySelector('.expand-btn').addEventListener('click', function() {
                    const details = JSON.parse(newRow.getAttribute('data-details'));
                    showDetailsPopup(details);
                });
                
                // æ¸…é™¤è¡¨å•
                clearForm();
                
                // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                saveDataToLocalStorage();
                
                // æ›´æ–°æ±‡æ€»
                updateSummary();
            }
            
            // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
            function showDetailsPopup(details) {
                // åˆ›å»ºå¼¹çª—
                const popupOverlay = document.createElement('div');
                popupOverlay.className = 'popup-overlay';
                
                const popupContent = document.createElement('div');
                popupContent.className = 'popup-content';
                
                popupContent.innerHTML = `
                    <div class="popup-header">
                        <div class="popup-title">
                            <i class="fas fa-info-circle" style="color: #007AFF;"></i> 
                            <span>è´·æ¬¾è¯¦æƒ… - ${details.clientName}</span>
                        </div>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-user"></i></div>
                            <div class="detail-label">å®¢æˆ·åç§°:</div>
                            <div class="detail-value">${details.clientName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-calendar-alt"></i></div>
                            <div class="detail-label">æ”¾æ¬¾æ—¥æœŸ:</div>
                            <div class="detail-value">${formatDate(details.loanDate)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-money-bill-wave"></i></div>
                            <div class="detail-label">æ”¾æ¬¾é‡‘é¢:</div>
                            <div class="detail-value">${formatNumber(details.loanAmount)} å…ƒ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-hand-holding-usd"></i></div>
                            <div class="detail-label">æœåŠ¡è´¹ç‡:</div>
                            <div class="detail-value">${details.serviceRate}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-tag"></i></div>
                            <div class="detail-label">æ¸ é“æˆæœ¬:</div>
                            <div class="detail-value">${formatNumber(details.channelCost)} å…ƒ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-gift"></i></div>
                            <div class="detail-label">è¿”ç‚¹é‡‘é¢:</div>
                            <div class="detail-value">${formatNumber(details.rebateAmount)} å…ƒ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-server"></i></div>
                            <div class="detail-label">å¹³å°æˆæœ¬:</div>
                            <div class="detail-value">${formatNumber(details.platformCost)} å…ƒ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-coins"></i></div>
                            <div class="detail-label">ææˆ:</div>
                            <div class="detail-value" style="font-weight: bold; color: ${details.commission >= 1000 ? '#34C759' : '#FF3B30'};">${formatNumber(details.commission)} å…ƒ</div>
                        </div>
                    </div>
                `;
                
                popupOverlay.appendChild(popupContent);
                document.body.appendChild(popupOverlay);
                
                // æ·»åŠ å…³é—­äº‹ä»¶
                const closeBtn = popupContent.querySelector('.close-btn');
                closeBtn.addEventListener('click', function() {
                    document.body.removeChild(popupOverlay);
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                popupOverlay.addEventListener('click', function(e) {
                    if (e.target === popupOverlay) {
                        document.body.removeChild(popupOverlay);
                    }
                });
            }
            
            // æ¸…é™¤è¡¨å•
            function clearForm() {
                clientNameInput.value = '';
                productTypeInput.selectedIndex = 0;
                loanAmountInput.value = '';
                serviceRateInput.value = '';
                channelCostInput.value = '';
                rebateRateInput.value = '0';
            }
            
            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            function saveDataToLocalStorage() {
                const rows = tableBody.querySelectorAll('tr');
                const data = [];
                
                rows.forEach(row => {
                    data.push(JSON.parse(row.getAttribute('data-details')));
                });

                // åœ¨åŸæ¥çš„ä¿å­˜å‡½æ•°é‡Œæ·»åŠ è¿™è¡Œä»£ç 
myIncomeData = incomeList; // å‡è®¾ä½ åŸæ¥çš„å˜é‡å« incomeList
// å¦‚æœä¸çŸ¥é“åŸæ¥çš„å˜é‡åï¼Œå¯ä»¥è¯•ç€ä¸åŠ è¿™è¡Œå…ˆæµ‹è¯•
                localStorage.setItem('loanData', JSON.stringify(data));
            }
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            function loadData() {
                const savedData = localStorage.getItem('loanData');
                
                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        
                        data.forEach(item => {
                            const newRow = document.createElement('tr');
                            newRow.setAttribute('data-date', item.loanDate);
                            newRow.setAttribute('data-commission', item.commission);
                            newRow.setAttribute('data-details', JSON.stringify(item));
                            
                            newRow.innerHTML = `
                                <td>${item.clientName}</td>
                                <td>${formatNumber(item.loanAmount)}</td>
                                <td class="${parseFloat(item.commission) >= 1000 ? 'commission-high' : 'commission-low'}">${formatNumber(item.commission)}</td>
                                <td class="action-cell">
                                    <button class="action-btn expand-btn" title="æŸ¥çœ‹è¯¦æƒ…">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="action-btn btn-delete delete-row" title="åˆ é™¤">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            `;
                            
                            tableBody.appendChild(newRow);
                            
                            // æ·»åŠ åˆ é™¤è¡Œçš„äº‹ä»¶ç›‘å¬å™¨
                            newRow.querySelector('.delete-row').addEventListener('click', function() {
                                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸€è¡Œå—ï¼Ÿ')) {
                                    newRow.remove();
                                    saveDataToLocalStorage();
                                    updateSummary();
                                }
                            });
                            
                            // æ·»åŠ æŸ¥çœ‹è¯¦æƒ…çš„äº‹ä»¶ç›‘å¬å™¨
                            newRow.querySelector('.expand-btn').addEventListener('click', function() {
                                showDetailsPopup(item);
                            });
                        });
                        
                        updateSummary();
                    } catch (e) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                    }
                }
            }
            
            // æ¸…é™¤æ‰€æœ‰æ•°æ®
            function clearAllData() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    tableBody.innerHTML = '';
                    localStorage.removeItem('loanData');
                    updateSummary();
                }
            }
            
            // å¯¼å‡ºCSV
            function exportToCSV() {
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows.length === 0) {
                    alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼');
                    return;
                }
                
                let csvContent = "å®¢æˆ·åç§°,äº§å“ç±»å‹,æ”¾æ¬¾æ—¥æœŸ,æ”¾æ¬¾é‡‘é¢,æœåŠ¡è´¹ç‡(%),æ¸ é“æˆæœ¬,è¿”ç‚¹é‡‘é¢,å¹³å°æˆæœ¬,ææˆ\n";
                
                rows.forEach(row => {
                    const details = JSON.parse(row.getAttribute('data-details'));
                    const rowData = [
                        details.clientName,
                        details.productType,
                        formatDate(details.loanDate),
                        details.loanAmount,
                        details.serviceRate,
                        details.channelCost,
                        details.rebateAmount,
                        details.platformCost,
                        details.commission
                    ];
                    
                    // å¤„ç†å¯èƒ½åŒ…å«é€—å·çš„å†…å®¹
                    const escapedData = rowData.map(item => `"${item}"`);
                    csvContent += escapedData.join(',') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `loan_data_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            addRowButton.addEventListener('click', addRow);
            clearDataButton.addEventListener('click', clearAllData);
            exportDataButton.addEventListener('click', exportToCSV);
        });
// ========== æ–°å¢çš„äº‘ç«¯æ“ä½œå‡½æ•° - ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯ ==========

// è®¾ç½®ä¸»å¯†ç 
function setMasterPassword() {
    const password = document.getElementById('master-password-input').value;
    if (!password) {
        alert('è¯·å…ˆè¾“å…¥åŠ å¯†å¯†ç ï¼');
        return;
    }
    window.masterPassword = password;
    alert('åŠ å¯†å¯†ç å·²è®¾ç½®æˆåŠŸï¼');
}

// ä¿å­˜æ•°æ®åˆ°äº‘ç«¯
async function saveDataToCloud() {
    if (!window.masterPassword) {
        alert('è¯·å…ˆè®¾ç½®åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    const token = prompt('è¯·è¾“å…¥ä½ çš„GitHub Tokenï¼š');
    if (!token) return;
    
    try {
        // é‡ç‚¹ï¼šéœ€è¦ä½ æŠŠè¿™é‡Œçš„ YOUR_DATA_VARIABLE æ›¿æ¢æˆä½ å®é™…ä½¿ç”¨çš„å˜é‡å
        await encryptAndSaveData(YOUR_DATA_VARIABLE, token);
        alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°Gitäº‘ç«¯ï¼');
    } catch (error) {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
    }
}

// ä»äº‘ç«¯åŠ è½½æ•°æ®
async function loadDataFromCloud() {
    if (!window.masterPassword) {
        alert('è¯·å…ˆè®¾ç½®åŠ å¯†å¯†ç ï¼');
        return;
    }
    
    const token = prompt('è¯·è¾“å…¥ä½ çš„GitHub Tokenï¼š');
    if (!token) return;
    
    try {
        const loadedData = await loadAndDecryptData(token);
        if (loadedData) {
            // é‡ç‚¹ï¼šéœ€è¦ä½ æŠŠè¿™é‡Œçš„ YOUR_DATA_VARIABLE æ›¿æ¢æˆä½ å®é™…ä½¿ç”¨çš„å˜é‡å
            myIncomeData = loadedData;
            alert('âœ… äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸï¼');
            // å¦‚æœé¡µé¢éœ€è¦åˆ·æ–°æ˜¾ç¤ºï¼Œè¯·å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
            // updateTableDisplay(); 
        }
    } catch (error) {
        alert('âŒ åŠ è½½å¤±è´¥ï¼š' + error.message);
    }
}
    </script>
</body>
</html>